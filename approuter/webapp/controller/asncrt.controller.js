sap.ui.define(["zmmsubcontract/controller/BaseController","sap/m/MessageBox","sap/m/MessageToast","zmmsubcontract/model/formatter"],function(e,t,r,a){return e.extend("zmmsubcontract.controller.asncrt",{formatter:a,onInit:function(){e.prototype.onInit.apply(this);this.oRouter=this.getOwnerComponent().getRouter();this.oRouter.getRoute("subconASNcr").attachPatternMatched(this._onObjectMatched,this);this._localModel=this.getOwnerComponent().getModel("local");oControl=this;var t=this.getOwnerComponent().getModel("poservice");this.getView().byId("idMachdrp").setSelectedKey("");this.fetchPackageType();this.fetchMachineList()},_onObjectMatched:function(e){this._refreshView()},onBeforeRendering:function(){if(this.oRouter){this.oRouter.getRoute("subconASNcr").detachPatternMatched(this._onObjectMatched,this)}},onAfterRendering:function(){this.oRouter.getRoute("subconASNcr").attachPatternMatched(this._onObjectMatched,this)},onSelectChange:function(e){var t=e.getSource();var r=t.getSelectedItem();this.sSelectedKey=r.getKey()},onMachineSelect:function(e){var t=e.getSource();var r=t.getSelectedItem();this.sSelectedMachine=r.getKey()},_refreshView:function(){this.getView().byId("idDcNo").setValue("");this.getView().byId("datePicker").setValue("");this.getView().byId("idInvQty").setValue("");this.getView().byId("idLrNo").setValue("");this.getView().byId("datePicker_lr").setValue("");this.getView().byId("idselpt").setValue("");this.getView().byId("idNoPckg").setValue("");this.getView().byId("idMatWgt").setValue("");this.getView().byId("idVhNo").setValue("");this.getView().byId("datePicker_ed").setValue("");this.getView().byId("idLifn2").setValue("");var e=this.getOwnerComponent().getModel("selectedRecords");var t=new sap.ui.model.json.JSONModel;t.setData(e.oData);this.getView().setModel(t,"regasnmodel")},onInvoiceQtyChange:function(e){var r=parseFloat(e.getSource().getValue());if(!r||r===0){t.error("Invoice quantity must not be zero");e.getSource().setValue("");return}var a=this.byId("idSelASN");var i=a.getItems();var s=0;i.forEach(function(e){var t=e.getCells();var r=parseFloat(t[8].getText());s+=r});if(r>s){t.error("Invoice quantity is greater than the total balance quantity.");return}i.forEach(function(e){var t=e.getCells();var a=parseFloat(t[8].getText());if(r>0){var i=Math.min(a,r);r-=i;var s=t[9];s.setValue(i.toFixed(2))}else{var s=t[9];s.setValue("0.00")}})},onSaveASN:async function(e){let r=this.getView().byId("idDcNo").getValue();let a=this.getView().byId("datePicker").getValue();let i=this.getView().byId("idInvQty").getValue();let s=this.getView().byId("idLrNo").getValue();let o=this.getView().byId("datePicker_lr").getValue();let n=this.getView().byId("idselpt").getSelectedKey();let l=this.getView().byId("idNoPckg").getValue();let d=this.getView().byId("idMatWgt").getValue();let c=this.getView().byId("idVhNo").getValue();debugger;let u=[{field:r,fieldId:"idDcNo",fieldName:"DC Number"},{field:a,fieldId:"datePicker",fieldName:"DC Date"},{field:i,fieldId:"idInvQty",fieldName:"Invoice Quantity"},{field:s,fieldId:"idLrNo",fieldName:"LR Number"},{field:o,fieldId:"datePicker_lr",fieldName:"LR Date"},{field:n,fieldId:"idselpt",fieldName:"Selection Point"},{field:l,fieldId:"idNoPckg",fieldName:"Number of Packages"},{field:d,fieldId:"idMatWgt",fieldName:"Material Weight"},{field:c,fieldId:"idVhNo",fieldName:"Vehicle Number"}];let g=false;u.forEach(function(e){if(!e.field){this.getView().byId(e.fieldId).setValueState(sap.ui.core.ValueState.Error);g=true}else{this.getView().byId(e.fieldId).setValueState(sap.ui.core.ValueState.None)}}.bind(this));if(g){t.error("Please fill in all mandatory fields.");return}this._userModel=this.getOwnerComponent().getModel("userModel");let h=this._userModel.oData.email;let p=[new sap.ui.model.Filter("Email",sap.ui.model.FilterOperator.EQ,h),new sap.ui.model.Filter("Dcno",sap.ui.model.FilterOperator.EQ,r),new sap.ui.model.Filter("Dcdate",sap.ui.model.FilterOperator.EQ,a)];oModel=this.getOwnerComponent().getModel("asncrt");var f=this.byId("idRadioGroup");var m=f.getSelectedIndex();oModel.read("/ZET_ASN_CRTSet",{filters:p,success:function(e,i){sap.ui.core.BusyIndicator.hide();if(e.results&&e.results.length>0){t.warning("The DC number "+r+" with date "+a+" already exists.")}else{if(m===0){this._checkmaxquantity().then(()=>{debugger;this._createASNRecord()}).catch(e=>{debugger;t.error(e)})}else{this._createASNRecord()}}}.bind(this),error:function(e){debugger;console.log(e);sap.ui.core.BusyIndicator.hide();t.error(JSON.parse(e.responseText).error.innererror.errordetails[0].message)}})},_checkmaxquantity:function(){return new Promise((e,r)=>{var a=this.byId("idSelASN");var i=a.getItems();var s=[];let o=this.getView().byId("idInvNo").getValue();let n=this.getView().byId("idInvItm").getValue();let l=this.getView().byId("idWerk").getValue();let d=this._userModel.oData.email;debugger;i.forEach(function(e){var t=e.getBindingContext("regasnmodel");if(t){var r=t.getProperty("Op_matnr");if(r){s.push(r)}}});var c=[];if(s.length>0){var u=s.map(function(e){return new sap.ui.model.Filter("Matnr",sap.ui.model.FilterOperator.EQ,e)});var g=new sap.ui.model.Filter({filters:u,and:false});c.push(g)}c.push(new sap.ui.model.Filter("Email",sap.ui.model.FilterOperator.EQ,d));c.push(new sap.ui.model.Filter("Ebeln",sap.ui.model.FilterOperator.EQ,o));c.push(new sap.ui.model.Filter("Ebelp",sap.ui.model.FilterOperator.EQ,n));c.push(new sap.ui.model.Filter("Werks",sap.ui.model.FilterOperator.EQ,l));oModel=this.getOwnerComponent().getModel("asncrt");oModel.read("/ZET_MAX_QTYSet",{filters:c,success:function(t,a){sap.ui.core.BusyIndicator.hide();debugger;var i=parseFloat(t.results[0].Maxv);var s=t.results[0].Maxind;let o=this.getView().byId("idInvQty").getValue();var n=parseFloat(o)||0;if(s==="X"){s=null;if(n>i){i=0;o=null;n=0;r("Quantity exceeds maximum stock!");return}}else if(s==="Y"){r("Maximum stock level not available for material!");return}e()}.bind(this),error:function(e){debugger;console.log(e);sap.ui.core.BusyIndicator.hide();t.error(JSON.parse(e.responseText).error.innererror.errordetails[0].message)}})})},_validateVehicleNumber:function(e,r){return new Promise(function(a){e.read("/VehicleNumberSet",{filters:r,success:function(e){if(e.results.length===1){t.error(e.results[0].Message);a(false)}else{a(true)}},error:function(){a(false)}})})},_createASNRecord:async function(){let e=this.getOwnerComponent().getModel("asncrt");this.getView().setModel(e);var t=this._localModel.getProperty("/asnData");var r=this.getView().byId("datePicker");var a=this.getView().byId("datePicker_ed");var i=this.getView().byId("datePicker_lr");var s=r.getValue();var o=a.getValue();var n=i.getValue();let l=this.getView().getModel("local");t.Dcdate=s;t.exDelvDate=o;t.Lrdate=n;t.Magrv=this.sSelectedKey;t.Arbpl=this.sSelectedMachine;var d=this.byId("idSelASN");var c=d.getItems();var u=[];c.forEach(function(e,r){var a=e.getCells();var i=a[9].getValue();if(i){if(r===0){t.Exnum1=a[0].mProperties.text,t.Menge1=i,t.Werks=a[2].mProperties.text,t.Lifnr=a[3].mProperties.text,t.Ebeln=a[10].mProperties.text,t.Ebelp=a[11].mProperties.text,t.Matnr=a[4].mProperties.text,t.Exyear1=a[12].mProperties.text}else if(r===1){t.Exnum2=a[0].mProperties.text,t.Exyear2=a[12].mProperties.text;t.Menge2=i}else if(r===2){t.Exnum3=a[0].mProperties.text,t.Exyear3=a[12].mProperties.text;t.Menge3=i}else if(r===3){t.Exnum4=a[0].mProperties.text,t.Exyear4=a[12].mProperties.text;t.Menge4=i}else{}}});var g=this.getOwnerComponent().getModel("ASNMODEL");var h=g.getData();t.Ebeln=h.Ebeln;t.Ebelp=h.Ebelp;var p=this.byId("idRadioGroup");var f=p.getSelectedIndex();if(f===0){t.Grstatus="C"}else if(f===1){t.Grstatus="N"}u.push(t);var m="CreateBatchGroup";e.setDeferredGroups([m]);let V=null;this.createAsn(t)},createAsn:async function(e){let r=this.getView().byId("idWerk").getValue();let a="5010";const i=await this.fetchMachineMandat(r,a);if(!i){return}debugger;$.ajax({url:"/nodeapp/custom/asnpost",type:"POST",contentType:"application/json; charset=UTF-8",data:JSON.stringify(e),headers:{"Content-Type":"application/json"},success:async function(e){debugger;const r=e.d.Asnno;try{t.success("ASN Number Created: "+e.d.Asnno,{onClose:async function(){var e=this.getView().getModel("local");e.setData({asnData:{Dcno:"",Menge:"",Lrnumber:"",Zpack:"",Asnweight:"",Vechileno:"",exDelvDate:"",Lrdate:""}});var t=this.getView().byId("idMachdrp");t.setSelectedKey(null);e.updateBindings(true);history.go(-1)}.bind(this)})}catch(e){t.error("ASN created, but there was an error uploading attachments.\n"+"Error Details: "+e.message)}}.bind(this),error:function(e){var r=e.status;var a=e.statusText;var i=e.responseText;t.error("Error occurred during ASN creation. "+"Status: "+r+" ("+a+")\n"+"Details: "+i)}})},uploadAttachments:async function(e){const a=this.getView().getModel("local");const i=a.getProperty("/attachData");debugger;const s=new sap.ui.model.odata.v2.ODataModel("/sap/opu/odata/sap/YMM_SUPPLIER_PO_SRV/");const o=(a,i,o,n)=>{if(!a||!i){return Promise.resolve()}let l=`${e}/`;l+=n+a;const d={AsnNumber:e,FileName:a,MimeType:o,Base64Content:i};const c={slug:l};return new Promise((e,i)=>{s.create("/AttachmentSet",d,{headers:c,success:function(){r.show(`File uploaded successfully: ${a}`);e()},error:function(e){t.error(`Error uploading file: ${a}`);i(e)}})})}},getCsrfToken:function(e){return new Promise(function(t,r){$.ajax({type:"GET",url:e,headers:{"X-CSRF-Token":"fetch","Content-Type":"application/json"},success:function(e,r,a){const i=a.getResponseHeader("X-CSRF-Token");debugger;t(i)},error:function(e,t,a){console.error("Failed to fetch CSRF token:",a);r(a)}})})},getCsrfToken_asn:function(e){return new Promise(function(t,r){$.ajax({type:"GET",url:e,headers:{"X-CSRF-Token":"fetch","Content-Type":"application/json"},success:function(e,r,a){const i=a.getResponseHeader("X-CSRF-Token");debugger;t(i)},error:function(e,t,a){console.error("Failed to fetch CSRF token:",a);r(a)}})})},onChange:function(e){var t=e.getParameter("state");var r=this.byId("idSecVend");r.setVisible(t);var a=this.byId("idLifn2");a.setVisible(t)},onDateChange:function(e){var t=e.getSource();var r=t.getValue();if(r){var a=new Date(r);var i=new Date;a.setHours(0,0,0,0);i.setHours(0,0,0,0);if(a>i){t.setValueState(sap.ui.core.ValueState.Error);t.setValueStateText("Future dates are not allowed.");t.setValue("");return}else{t.setValueState(sap.ui.core.ValueState.None)}}},onExpDelivChange:function(e){var t=e.getSource();var r=t.getValue();if(r){var a=new Date(r);var i=new Date;a.setHours(0,0,0,0);i.setHours(0,0,0,0);if(a<i){t.setValueState(sap.ui.core.ValueState.Error);t.setValueStateText("Past dates are not allowed.");t.setValue("");return}else{t.setValueState(sap.ui.core.ValueState.None)}}},onAsnweight:function(e){var t=e.getSource();var r=t.getValue();var a=/^[0-9]*\.?[0-9]*$/;if(a.test(r)){t.setValueState(sap.ui.core.ValueState.None)}else{t.setValueState(sap.ui.core.ValueState.Error);t.setValueStateText("Please enter a valid number with or without decimals.")}},fetchPackageType:async function(){const e=this;sap.ui.core.BusyIndicator.show();try{const t=await $.ajax({url:"/nodeapp/packtype",method:"GET",contentType:"application/json"});sap.ui.core.BusyIndicator.hide();const r=t;const a=new sap.ui.model.json.JSONModel(r);e.getView().setModel(a,"dropModel")}catch(e){sap.ui.core.BusyIndicator.hide();console.error("Error fetching Package Type:",e);const t=e.responseJSON?.error?.innererror?.errordetails?.[0]?.message||"Unknown error occurred"}},fetchMachineMandat:async function(e,r){debugger;const a=this;try{const a=await $.ajax({url:"/nodeapp/mandtmachine",method:"GET",contentType:"application/json",data:{werks:e,bukrs:r}});console.log("response is ",a);debugger;const i=a[0].Machine;const s=this.getView().byId("idMachdrp");const o=s.getSelectedKey();const n=this.getView().byId("idMachineLabel");if(i){n.setRequired(true)}else{n.setRequired(false)}if(i&&!o){t.error("Please fill in the Machine field, as it is mandatory.",{onClose:()=>{s.focus()}});return false}return true}catch(e){debugger}},fetchMachineList:async function(){const e=this;sap.ui.core.BusyIndicator.show();try{const t=await $.ajax({url:"/nodeapp/machinelist",method:"GET",contentType:"application/json"});sap.ui.core.BusyIndicator.hide();const r=t;const a=new sap.ui.model.json.JSONModel(r);e.getView().setModel(a,"MachListModel")}catch(e){sap.ui.core.BusyIndicator.hide();console.error("Error fetching Package Type:",e);const r=e.responseJSON?.error?.innererror?.errordetails?.[0]?.message||"Unknown error occurred";t.error(r)}},onNumberValidation:function(e){const t=e.getParameter("value");const r=e.getSource();const a=/^[0-9]*$/;if(!a.test(t)){r.setValueState("Error");r.setValueStateText("Please Enter Numbers only")}else{r.setValueState("None")}},onDCNOValidation:function(e){var t=e.getParameter("value");var r=e.getSource();if(t.length>16){r.setValueState("Error");r.setValueStateText("Only 16 characters allowed")}else{r.setValueState("None")}}})});
//# sourceMappingURL=asncrt.controller.js.map