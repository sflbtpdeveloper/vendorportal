sap.ui.define(["zmmsubcontract/controller/BaseController","sap/m/MessageBox","sap/m/MessageToast","zmmsubcontract/model/formatter"],function(e,t,a,r){return e.extend("zmmsubcontract.controller.asncrt",{formatter:r,onInit:function(){e.prototype.onInit.apply(this);this.oRouter=this.getOwnerComponent().getRouter();this.oRouter.getRoute("subconASNcr").attachPatternMatched(this._onObjectMatched,this);this._localModel=this.getOwnerComponent().getModel("local");oControl=this;var t=this.getOwnerComponent().getModel("poservice");this.getView().byId("idMachdrp").setSelectedKey("");this.fetchPackageType();this.fetchMachineList()},_onObjectMatched:function(e){this._refreshView()},onBeforeRendering:function(){if(this.oRouter){this.oRouter.getRoute("subconASNcr").detachPatternMatched(this._onObjectMatched,this)}},onAfterRendering:function(){this.oRouter.getRoute("subconASNcr").attachPatternMatched(this._onObjectMatched,this)},onSelectChange:function(e){var t=e.getSource();var a=t.getSelectedItem();this.sSelectedKey=a.getKey()},onMachineSelect:function(e){var t=e.getSource();var a=t.getSelectedItem();this.sSelectedMachine=a.getKey()},_refreshView:function(){this.getView().byId("idDcNo").setValue("");this.getView().byId("datePicker").setValue("");this.getView().byId("idInvQty").setValue("");this.getView().byId("idInvVal").setValue("");this.getView().byId("idRem").setValue("");this.getView().byId("idLrNo").setValue("");this.getView().byId("datePicker_lr").setValue("");this.getView().byId("idselpt").setValue("");this.getView().byId("idNoPckg").setValue("");this.getView().byId("idMatWgt").setValue("");this.getView().byId("idVhNo").setValue("");this.getView().byId("datePicker_ed").setValue("");this.getView().byId("idLifn2").setValue("");this.getView().byId("idMachdrp").setSelectedKey("");this.getView().byId("invoiceFileName").setText("");this.getView().byId("dhsFileName").setText("");const e=this.getView().byId("invoiceAttachment");const t=this.getView().byId("dhsAttachment");if(e){e.setValue("")}if(t){t.setValue("")}var a=this.byId("invoiceFileName");if(a){a.setText("")}var r=this.byId("dhsFileName");if(r){r.setText("")}const i=new sap.ui.model.json.JSONModel({isSaveEnabled:true});this.getView().setModel(i,"saveButtonModel");debugger;this.getView().getModel("saveButtonModel").setProperty("/isSaveEnabled",true);var s=this.getOwnerComponent().getModel("selectedRecords");var o=new sap.ui.model.json.JSONModel;o.setData(s.oData);this.getView().setModel(o,"regasnmodel")},onInvoiceQtyChange:function(e){var a=parseFloat(e.getSource().getValue());if(!a||a===0){t.error("Invoice quantity must not be zero");e.getSource().setValue("");return}var r=this.byId("idSelASN");var i=r.getItems();var s=0;i.forEach(function(e){var t=e.getCells();var a=parseFloat(t[8].getText());s+=a});if(a>s){t.error("Invoice quantity is greater than the total balance quantity.");return}i.forEach(function(e){var t=e.getCells();var r=parseFloat(t[8].getText());if(a>0){var i=Math.min(r,a);a-=i;var s=t[9];s.setValue(i.toFixed(3))}else{var s=t[9];s.setValue("0.000")}})},onSaveASN:async function(e){this.getView().getModel("saveButtonModel").setProperty("/isSaveEnabled",false);let a=this.getView().byId("idDcNo").getValue();let r=this.getView().byId("datePicker").getValue();let i=this.getView().byId("idInvQty").getValue();let s=this.getView().byId("idInvVal").getValue();let o=this.getView().byId("idRem").getValue();let n=this.getView().byId("idLrNo").getValue();let l=this.getView().byId("datePicker_lr").getValue();let d=this.getView().byId("idselpt").getSelectedKey();let c=this.getView().byId("idNoPckg").getValue();let u=this.getView().byId("idMatWgt").getValue();let h=this.getView().byId("idVhNo").getValue().replace(/\s+/g,"");debugger;let g=[{field:a,fieldId:"idDcNo",fieldName:"DC Number"},{field:r,fieldId:"datePicker",fieldName:"DC Date"},{field:i,fieldId:"idInvQty",fieldName:"Invoice Quantity"},{field:d,fieldId:"idselpt",fieldName:"Selection Point"},{field:c,fieldId:"idNoPckg",fieldName:"Number of Packages"},{field:u,fieldId:"idMatWgt",fieldName:"Material Weight"},{field:h,fieldId:"idVhNo",fieldName:"Vehicle Number"}];let p=false;g.forEach(function(e){if(!e.field){this.getView().byId(e.fieldId).setValueState(sap.ui.core.ValueState.Error);p=true}else{this.getView().byId(e.fieldId).setValueState(sap.ui.core.ValueState.None)}}.bind(this));if(p){this.getView().getModel("saveButtonModel").setProperty("/isSaveEnabled",true);t.error("Please fill in all mandatory fields.");return}var f=this.getOwnerComponent().getModel("selectedRecords");var m=f.oData[0].Aedat;const y=r;const V=new Date(y);V.setHours(0,0,0,0);var v=m.substring(0,4);var b=m.substring(4,6);var w=m.substring(6,8);var m=new Date(v,b-1,w);m.setHours(0,0,0,0);if(V<m){sap.m.MessageBox.error("DC date is Prior than PO creation date");return}let S=this.byId("idSelASN");let I=S.getItems();let M=0;let N=parseFloat(i)||0;I.forEach(function(e){let t=e.getCells();let a=parseFloat(t[9].getValue());if(!isNaN(a)){M+=a}});if(M>N){this.getView().getModel("saveButtonModel").setProperty("/isSaveEnabled",true);t.error(`The total allocated quantity (${M.toFixed(2)}) exceeds the invoice quantity (${N.toFixed(2)}).`);return}this._userModel=this.getOwnerComponent().getModel("userModel");let P=this._userModel.oData.email;let x=[new sap.ui.model.Filter("Email",sap.ui.model.FilterOperator.EQ,P),new sap.ui.model.Filter("Dcno",sap.ui.model.FilterOperator.EQ,a),new sap.ui.model.Filter("Dcdate",sap.ui.model.FilterOperator.EQ,r)];oModel=this.getOwnerComponent().getModel("asncrt");var E=this.byId("idRadioGroup");var F=E.getSelectedIndex();oModel.read("/ZET_ASN_DUPLSet",{filters:x,success:function(e,i){sap.ui.core.BusyIndicator.hide();if(e.results&&e.results.length>0){this.getView().getModel("saveButtonModel").setProperty("/isSaveEnabled",true);t.warning("The DC number "+a+" with date "+r+" already exists.")}else{if(F===0){this._checkmaxquantity().then(()=>{debugger;this.getView().getModel("saveButtonModel").setProperty("/isSaveEnabled",false);this._createASNRecord()}).catch(e=>{debugger;this.getView().getModel("saveButtonModel").setProperty("/isSaveEnabled",true);t.error(e)})}else{this._createASNRecord()}}}.bind(this),error:function(e){debugger;this.getView().getModel("saveButtonModel").setProperty("/isSaveEnabled",true);console.log(e);sap.ui.core.BusyIndicator.hide();t.error(JSON.parse(e.responseText).error.innererror.errordetails[0].message)}.bind(this)})},_checkmaxquantity:function(){return new Promise((e,a)=>{var r=this.byId("idSelASN");var i=r.getItems();var s=[];let o=this.getView().byId("idInvNo").getValue();let n=this.getView().byId("idInvItm").getValue();let l=this.getView().byId("idWerk").getValue();let d=this._userModel.oData.email;debugger;i.forEach(function(e){var t=e.getBindingContext("regasnmodel");if(t){var a=t.getProperty("Op_matnr");if(a){s.push(a)}}});var c=[];if(s.length>0){var u=s.map(function(e){return new sap.ui.model.Filter("Matnr",sap.ui.model.FilterOperator.EQ,e)});var h=new sap.ui.model.Filter({filters:u,and:false});c.push(h)}c.push(new sap.ui.model.Filter("Email",sap.ui.model.FilterOperator.EQ,d));c.push(new sap.ui.model.Filter("Ebeln",sap.ui.model.FilterOperator.EQ,o));c.push(new sap.ui.model.Filter("Ebelp",sap.ui.model.FilterOperator.EQ,n));c.push(new sap.ui.model.Filter("Werks",sap.ui.model.FilterOperator.EQ,l));oModel=this.getOwnerComponent().getModel("asncrt");oModel.read("/ZET_MAX_QTYSet",{filters:c,success:function(t,r){sap.ui.core.BusyIndicator.hide();debugger;var i=parseFloat(t.results[0].Maxv);var s=t.results[0].Maxind;let o=this.getView().byId("idInvQty").getValue();var n=parseFloat(o)||0;if(s==="X"){s=null;if(n>i){i=0;o=null;n=0;a("Quantity exceeds maximum stock!");return}}else if(s==="Y"){a("Maximum stock level not available for material!");return}e()}.bind(this),error:function(e){debugger;console.log(e);sap.ui.core.BusyIndicator.hide();t.error(JSON.parse(e.responseText).error.innererror.errordetails[0].message)}})})},_validateVehicleNumber:function(e,a){return new Promise(function(r){e.read("/VehicleNumberSet",{filters:a,success:function(e){if(e.results.length===1){t.error(e.results[0].Message);r(false)}else{r(true)}},error:function(){r(false)}})})},_createASNRecord:async function(){let e=this.getOwnerComponent().getModel("asncrt");this.getView().setModel(e);var t=this._localModel.getProperty("/asnData");var a=this.getView().byId("datePicker");var r=this.getView().byId("datePicker_ed");var i=this.getView().byId("datePicker_lr");var s=a.getValue();var o=r.getValue();var n=i.getValue();let l=this.getView().getModel("local");t.Dcdate=s;t.exDelvDate=o;t.Lrdate=n;t.Magrv=this.sSelectedKey;t.Arbpl=this.sSelectedMachine;var d=this.byId("idSelASN");var c=d.getItems();var u=[];c.forEach(function(e,a){var r=e.getCells();var i=r[9].getValue();if(i){if(a===0){t.Exnum1=r[0].mProperties.text,t.Menge1=i,t.Werks=r[2].mProperties.text,t.Lifnr=r[3].mProperties.text,t.Ebeln=r[10].mProperties.text,t.Ebelp=r[11].mProperties.text,t.Matnr=r[4].mProperties.text,t.Exyear1=r[12].mProperties.text}else if(a===1){t.Exnum2=r[0].mProperties.text,t.Exyear2=r[12].mProperties.text;t.Menge2=i}else if(a===2){t.Exnum3=r[0].mProperties.text,t.Exyear3=r[12].mProperties.text;t.Menge3=i}else if(a===3){t.Exnum4=r[0].mProperties.text,t.Exyear4=r[12].mProperties.text;t.Menge4=i}else{}}});var h=this.getOwnerComponent().getModel("ASNMODEL");var g=h.getData();t.Ebeln=g.Ebeln;t.Ebelp=g.Ebelp;var p=this.byId("idRadioGroup");var f=p.getSelectedIndex();if(f===0){t.Grstatus="C"}else if(f===1){t.Grstatus="N"}u.push(t);var m="CreateBatchGroup";e.setDeferredGroups([m]);let y=null;this.createAsn(t)},createAsn:async function(e){this.getView().getModel("saveButtonModel").setProperty("/isSaveEnabled",false);let a=this.getView().byId("idWerk").getValue();let r="5010";const i=await this.fetchMachineMandat(a,r);if(!i){return}debugger;$.ajax({url:"/nodeapp/custom/asnpost",type:"POST",contentType:"application/json; charset=UTF-8",data:JSON.stringify(e),headers:{"Content-Type":"application/json"},success:async function(e){debugger;const a=e.d.Asnno;try{await this.uploadAttachments(a);t.success("ASN Number Created: "+e.d.Asnno,{onClose:async function(){var e=this.getView().getModel("local");e.setData({asnData:{Dcno:"",Menge:"",Lrnumber:"",Zpack:"",Asnweight:"",Vechileno:"",exDelvDate:"",Lrdate:""},attachData:{mimetype:"",InvoiceFileName:"",InvoiceFileBase64:"",DhsFileName:"",DhsFileBase64:""}});var t=this.getView().byId("idMachdrp");t.setSelectedKey(null);e.updateBindings(true);history.go(-1)}.bind(this)})}catch(e){t.error("ASN created, but there was an error uploading attachments.\n"+"Error Details: "+e.message)}}.bind(this),error:function(e){var a=e.status;var r=e.statusText;var i=e.responseText;this.getView().getModel("saveButtonModel").setProperty("/isSaveEnabled",true);t.error("Error occurred during ASN creation. "+"Status: "+a+" ("+r+")\n"+"Details: "+i)}.bind(this)})},uploadAttachments:async function(e){const t=this.getView().getModel("local");const a=t.getProperty("/attachData");debugger;const r=new sap.ui.model.odata.v2.ODataModel("/sap/opu/odata/sap/YMM_SUPPLIER_PO_SRV/");const i=()=>new Promise((e,t)=>{r.refreshSecurityToken(()=>{const a=r.getSecurityToken();if(a){e(a)}else{t(new Error("Failed to retrieve CSRF token."))}},e=>{t(new Error("Failed to refresh CSRF token: "+JSON.stringify(e)))})});const s=(t,a,r)=>{if(!t){return Promise.resolve()}let s=`${e}/`;s+=r+t;var o;if(r==="INV"){o=this.getView().byId("invoiceAttachment")}else if(r==="DHS"){o=this.getView().byId("dhsAttachment")}if(o){o.destroyHeaderParameters();o.addHeaderParameter(new sap.ui.unified.FileUploaderParameter({name:"SLUG",value:s}));return new Promise(async(e,t)=>{try{const a=await i();o.addHeaderParameter(new sap.ui.unified.FileUploaderParameter({name:"x-csrf-token",value:a}));o.setSendXHR(true);o.upload();o.attachUploadComplete(a=>{const r=a.getParameter("status");if(r===200||r===201){e()}else{t(new Error("File upload failed with status: "+r))}})}catch(e){t(e)}})}};const o=this.getView().byId("invoiceAttachment");const n=this.getView().byId("dhsAttachment");if(a.InvoiceFileName){await s(a.InvoiceFileName,a.mimetype,"INV")}if(a.DhsFileName){await s(a.DhsFileName,a.mimetype,"DHS")}if(o){o.setValue("")}if(n){n.setValue("")}t.setProperty("/attachData/InvoiceFileName","");t.setProperty("/attachData/DhsFileName","");this.byId("invoiceFileName").setText("");this.byId("dhsFileName").setText("")},getCsrfToken:function(e){return new Promise(function(t,a){$.ajax({type:"GET",url:e,headers:{"X-CSRF-Token":"fetch","Content-Type":"application/json"},success:function(e,a,r){const i=r.getResponseHeader("X-CSRF-Token");debugger;t(i)},error:function(e,t,r){console.error("Failed to fetch CSRF token:",r);a(r)}})})},getCsrfToken_asn:function(e){return new Promise(function(t,a){$.ajax({type:"GET",url:e,headers:{"X-CSRF-Token":"fetch","Content-Type":"application/json"},success:function(e,a,r){const i=r.getResponseHeader("X-CSRF-Token");debugger;t(i)},error:function(e,t,r){console.error("Failed to fetch CSRF token:",r);a(r)}})})},onChange:function(e){var t=e.getParameter("state");var a=this.byId("idSecVend");a.setVisible(t);var r=this.byId("idLifn2");r.setVisible(t)},onDateChange:function(e){var t=e.getSource();var a=t.getValue();if(a){var r=new Date(a);var i=new Date;r.setHours(0,0,0,0);i.setHours(0,0,0,0);if(r>i){t.setValueState(sap.ui.core.ValueState.Error);t.setValueStateText("Future dates are not allowed.");t.setValue("");return}else{t.setValueState(sap.ui.core.ValueState.None)}}},onExpDelivChange:function(e){var t=e.getSource();var a=t.getValue();if(a){var r=new Date(a);var i=new Date;r.setHours(0,0,0,0);i.setHours(0,0,0,0);if(r<i){t.setValueState(sap.ui.core.ValueState.Error);t.setValueStateText("Past dates are not allowed.");t.setValue("");return}else{t.setValueState(sap.ui.core.ValueState.None)}}},onAsnweight:function(e){var t=e.getSource();var a=t.getValue();var r=/^[0-9]*\.?[0-9]*$/;if(r.test(a)){t.setValueState(sap.ui.core.ValueState.None)}else{t.setValueState(sap.ui.core.ValueState.Error);t.setValueStateText("Please enter a valid number with or without decimals.")}},fetchPackageType:async function(){const e=this;sap.ui.core.BusyIndicator.show();try{const t=await $.ajax({url:"/nodeapp/packtype",method:"GET",contentType:"application/json"});sap.ui.core.BusyIndicator.hide();const a=t;const r=new sap.ui.model.json.JSONModel(a);e.getView().setModel(r,"dropModel")}catch(e){sap.ui.core.BusyIndicator.hide();console.error("Error fetching Package Type:",e);const t=e.responseJSON?.error?.innererror?.errordetails?.[0]?.message||"Unknown error occurred"}},fetchMachineMandat:async function(e,a){debugger;const r=this;try{const r=await $.ajax({url:"/nodeapp/mandtmachine",method:"GET",contentType:"application/json",data:{werks:e,bukrs:a}});console.log("response is ",r);debugger;const i=r[0].Machine;const s=this.getView().byId("idMachdrp");const o=s.getSelectedKey();const n=this.getView().byId("idMachineLabel");if(i){n.setRequired(true)}else{n.setRequired(false)}if(i&&!o){t.error("Please fill in the Machine field, as it is mandatory.",{onClose:()=>{s.focus()}});return false}return true}catch(e){debugger}},fetchMachineList:async function(){const e=this;sap.ui.core.BusyIndicator.show();try{const t=await $.ajax({url:"/nodeapp/machinelist",method:"GET",contentType:"application/json"});sap.ui.core.BusyIndicator.hide();const a=t;const r=new sap.ui.model.json.JSONModel(a);e.getView().setModel(r,"MachListModel")}catch(e){sap.ui.core.BusyIndicator.hide();console.error("Error fetching Package Type:",e);const a=e.responseJSON?.error?.innererror?.errordetails?.[0]?.message||"Unknown error occurred";t.error(a)}},onNumberValidation:function(e){const t=e.getParameter("value");const a=e.getSource();const r=/^[0-9]*$/;if(!r.test(t)){a.setValueState("Error");a.setValueStateText("Please Enter Numbers only")}else{a.setValueState("None")}},onDCNOValidation:function(e){var t=e.getParameter("value");var a=e.getSource();if(t.length>16){a.setValueState("Error");a.setValueStateText("Only 16 characters allowed")}else{a.setValueState("None")}},onFileChangedI:function(e){var t=e.getSource();var a=t.getValue();this.getView().getModel("local").setProperty("/attachData/InvoiceFileName",a);var r=this.byId("invoiceFileName");r.setText(a)},onFileChangedT:function(e){var t=e.getSource();var a=t.getValue();this.getView().getModel("local").setProperty("/attachData/DhsFileName",a);var r=this.byId("dhsFileName");r.setText(a)}})});
//# sourceMappingURL=asncrt.controller.js.map