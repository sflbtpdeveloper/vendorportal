sap.ui.define(["zmmsubcontract/controller/BaseController","sap/m/MessageBox","sap/m/MessageToast","sap/ui/model/json/JSONModel","sap/ui/core/Fragment","sap/ui/core/date/UI5Date","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/PDFViewer","sap/ui/core/Popup","sap/m/Popover"],function(e,t,r,a,o,n,i,s,l,d,g){"use strict";return e.extend("zmmsubcontract.controller.RegularASN",{_data:{dtValue:n.getInstance(),dtPattern:undefined},onInit:function(){e.prototype.onInit.apply(this);this._vMenge=null;this._localModel=this.getOwnerComponent().getModel("local");debugger;this.oRouter.getRoute("RegASN").attachPatternMatched(this._onObjectMatched,this);this.oRouter=this.getOwnerComponent().getRouter();this._userModel=this.getOwnerComponent().getModel("userModel");let t=localStorage.getItem("userInfo");if(t){let e=JSON.parse(t);this._userModel.setProperty("/",{email:e.email,user:e.user,scopes:e.scopes})}this.oRouter=this.getOwnerComponent().getRouter()},_readData:function(){this.getView().byId("idFilPlant1").setValue("");this.getView().byId("idFilDA1").setValue("");this.getView().byId("idFilVen1").setValue("");this.getView().byId("idMat1").setValue("");this.getView().byId("idPO1").setValue("");this._userModel=this.getOwnerComponent().getModel("userModel");let e=this._userModel.oData.email;debugger;let t=[new sap.ui.model.Filter("Email",sap.ui.model.FilterOperator.EQ,e)];var r=this.getOwnerComponent().getModel();var o=this.getOwnerComponent().getModel("selectedRecords");if(!o){o=new a([]);this.getOwnerComponent().setModel(o,"selectedRecords")}var n=this.getOwnerComponent().getModel("changedRecords");if(!n){n=new a([]);this.getOwnerComponent().setModel(n,"changedRecords")}this.getView().byId("idRegASN").setModel(r);var i=this;sap.ui.core.BusyIndicator.show(0);this.getOwnerComponent().setModel(r,"defaultModel");this.fetchDAList(e)},_onObjectMatched:function(e){this._refreshView()},_refreshView:function(){this._readData()},onSearchVendor:function(e){this._applySearchFilter("Lifnr",e.getParameter("query"))},onSearchWerks:function(e){this._applySearchFilter("Werks",e.getParameter("query"))},_applySearchFilter:function(e,t){var r=[];debugger;if(t&&t.length>0){var a=new i(e,s.Contains,t);r.push(a)}var o=this.byId("idDetail");var n=o.getBinding("items");n.filter(r,"Application")},_selectedData:function(e){var r=this.getOwnerComponent().getModel("selectedRecords");var a=this.getView();var o=a.byId("idRegASN");var n=o.getSelectedItems();var i=[];if(n.length===0){debugger;t.error("Please Enter at least one Record");return}var s=n[0].getBindingContext("default");var l=s.getProperty("Ebeln");var d=s.getProperty("Ebelp");debugger;n.forEach(function(e,r){r=r+1;if(r>4){t.error("You have selected more than 4 items. Please select up to 4 items only.");return}});var g=n.every(function(e){var t=e.getBindingContext("default");if(t){var r=t.getProperty("Ebeln");var a=t.getProperty("Ebelp");return r===l&&a===d}return false});if(!g){t.error("Please select records with the same PO and PO Line Item.");return}debugger;n.forEach(function(e){var t=e.getBindingContext("default");if(t){var r=t.getObject();i.push(t.getObject())}else{console.log("No binding context found for item:",e)}});sap.ui.getCore().setModel(r,"selectedItemsModel");r.setData(i);var c=sap.ui.core.UIComponent.getRouterFor(this);c.navTo("subconASNcr",{},false);debugger;var u={};u.vendor=r.oData[0].Lifnr;u.plant=r.oData[0].Werks;u.outputmat=r.oData[0].Op_matnr;u.Ebeln=r.oData[0].Ebeln;u.Ebelp=r.oData[0].Ebelp;u.Aedat=r.oData[0].Aedat;var h=new sap.ui.model.json.JSONModel;h.setData(u);this.getOwnerComponent().setModel(h,"ASNMODEL");this._displayCrtAsnEH()},onCreateASN:function(e){this._selectedData(e)},_displayCrtAsnEH:function(){this.oRouter.navTo("subconASNcr")},onPreviewPDF:function(e){var t=e.getSource();var r=t.getBindingContext("default");var a=r.getObject();var o=this.getView();var n=o.getModel();var i=new l;this.getView().addDependent(i);var s="/zdapdfSet(Werks='"+a.Werks+"',Lifnr='"+a.Lifnr+"',Exnum='"+a.Exnum+"',Exdat='"+a.Exdat+"')/$value";n.read(s,{success:function(e){var t=n.sServiceUrl+s;i.setSource(t);i.setTitle("DA PDF");i.open()},error:function(e){var t="Preview not available for this Challan !!!";sap.m.MessageBox.error(t)}})},onMat:function(e){debugger;var t=e.getParameter("newValue");var r=this.byId("idRegASN");var a=r.getBinding("items");var o=[];if(t&&t.length>0){var n=new i("Op_matnr",s.Contains,t);var l=new i("Ip_Matnr",s.Contains,t);o.push(new i({filters:[n,l],and:false}))}a.filter(o)},onPlant:function(e){debugger;var t=e.getParameter("newValue");var r=this.byId("idRegASN");var a=r.getBinding("items");var o=[];if(t&&t.length>0){var n=new i("Werks",s.Contains,t);o.push(new i({filters:[n],and:false}))}a.filter(o)},onDA:function(e){debugger;var t=e.getParameter("newValue");var r=this.byId("idRegASN");var a=r.getBinding("items");var o=[];if(t&&t.length>0){var n=new i("Exnum",s.Contains,t);o.push(new i({filters:[n],and:false}))}a.filter(o)},onPO:function(e){debugger;var t=e.getParameter("newValue");var r=this.byId("idRegASN");var a=r.getBinding("items");var o=[];if(t&&t.length>0){var n=new i("Ebeln",s.Contains,t);o.push(new i({filters:[n],and:false}))}a.filter(o)},onVendor:function(e){debugger;var t=e.getParameter("newValue");var r=this.byId("idRegASN");var a=r.getBinding("items");var o=[];if(t&&t.length>0){var n=new i("Lifnr",s.Contains,t);o.push(new i({filters:[n],and:false}))}a.filter(o)},fetchDAList:async function(e){debugger;const t=this;sap.ui.core.BusyIndicator.show();try{const r=await $.ajax({url:"/nodeapp/dalist",method:"GET",contentType:"application/json",data:{email:e}});sap.ui.core.BusyIndicator.hide();const a=r;debugger;const o=new sap.ui.model.json.JSONModel(a);t.getView().setModel(o,"default");console.log("DA List fetched successfully:",a)}catch(e){sap.ui.core.BusyIndicator.hide();console.error("Error fetching DA List:",e);const t=e.responseJSON?.error?.innererror?.errordetails?.[0]?.message||"Unknown error occurred"}},onChangeMat:function(e){this._selectedPO(e)},_selectedPO:async function(e){var r=this.getOwnerComponent().getModel("selectedRecords");var a=this.getView();var o=a.byId("idRegASN");var n=o.getSelectedItems();var i=[];if(n.length===0){debugger;t.error("Please Enter at least one Record");return}var s=n[0].getBindingContext("default");var l=s.getProperty("Ebeln");var d=s.getProperty("Ebelp");debugger;n.forEach(function(e,r){r=r+1;if(r>1){t.error("You have selected more than 1 items. Please select 1 record only.");return}});debugger;n.forEach(function(e){var t=e.getBindingContext("default");if(t){var r=t.getObject();i.push(t.getObject())}else{console.log("No binding context found for item:",e)}});sap.ui.getCore().setModel(r,"selectedItemsModel");r.setData(i);debugger;var g={};g.vendor=r.oData[0].Lifnr;g.plant=r.oData[0].Werks;g.outputmat=r.oData[0].Op_matnr;g.Ebeln=r.oData[0].Ebeln;g.Ebelp=r.oData[0].Ebelp;const c=r.oData[0].Ebeln;const u=r.oData[0].Ebelp;const h=r.oData[0].Ip_Matnr;const p=r.oData[0].Lifnr;const f=r.oData[0].Werks;const v=r.oData[0].Op_Matnr;this._vMenge=r.oData[0].Menge-r.oData[0].Menga;var m=new sap.ui.model.json.JSONModel;m.setData(g);this.getOwnerComponent().setModel(m,"ASNMODEL");debugger;const M={ebeln:c,ebelp:u,ip_matnr:h,lifnr:p,werks:f};try{const e=await $.ajax({url:"/nodeapp/changemat",method:"GET",contentType:"application/json",data:M});sap.ui.core.BusyIndicator.hide();debugger;const t=e;if(t.length===0){sap.m.MessageBox.error("No records found for the selected PO");return}this._displaySelectMatRatio(t,c,u)}catch(e){sap.ui.core.BusyIndicator.hide();console.error("Error fetching Change Mat:",e);const t=e.responseJSON?.error?.innererror?.errordetails?.[0]?.message||"Unknown error occurred"}},_displaySelectMatRatio:function(e,t,r){const a=new sap.ui.model.json.JSONModel(e);this.getView().setModel(a,"SelectMatModel");debugger;if(!this._oSelectMaterialDialog){o.load({id:this.getView().getId(),name:"zmmsubcontract.fragments.selMatPop",controller:this}).then(function(e){this._oSelectMaterialDialog=e;this.getView().addDependent(this._oSelectMaterialDialog);var t=sap.ui.core.Fragment.byId(this.getView().getId(),"idMaterialTable");if(t){t.setModel(this.getView().getModel("SelectMatModel"),"SelectMatModel")}this._oSelectMaterialDialog.open()}.bind(this)).catch(function(e){console.error("Error loading fragment:",e)})}else{var n=sap.ui.core.Fragment.byId(this.getView().getId(),"idMaterialTable");if(n){n.setModel(this.getView().getModel("SelectMatModel"),"SelectMatModel")}this._oSelectMaterialDialog.open()}},onCloseSelectMaterialDialog:function(){this._oSelectMaterialDialog.close()},onChangeSelectedMaterial:function(e){debugger;const r=this._vMenge;this.selectedchangedMaterial(e);debugger;var a=this.getOwnerComponent().getModel("selectedRecords");var o=this.getOwnerComponent().getModel("changedRecords");var n=this.getOwnerComponent().getModel("ASNMODEL");var i=a.getData();var s=o.getData();var l=n.getData();var d=s[0].Ratio;var g=r/d;g=parseFloat(g.toFixed(3));if(i&&i.length>0){i[0].Balqty=g;i[0].Op_matnr=s[0].Op_matnr;a.setData(i);this.getView().getModel("selectedRecords").refresh(true);l.Ebelp=s[0].Ebelp;n.setData(l);this.getView().getModel("ASNMODEL").refresh(true)}else{t.error("No data found in the selected records model.")}this._displayCrtAsnEH();this._oSelectMaterialDialog.close()},selectedchangedMaterial:function(e){var r=this.getOwnerComponent().getModel("changedRecords");var a=this.byId("idMaterialTable");var o=a.getSelectedItems();var n=[];debugger;if(o.length===0){debugger;t.error("Please Enter at least one Record");return}debugger;o.forEach(function(e){var t=e.getBindingContext("SelectMatModel");if(t){var r=t.getObject();n.push(t.getObject())}else{console.log("No binding context found for item:",e)}});sap.ui.getCore().setModel(r,"selectedItemsModel");r.setData(n)}})});
//# sourceMappingURL=RegularASN.controller.js.map