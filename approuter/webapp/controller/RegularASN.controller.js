sap.ui.define(["zmmsubcontract/controller/BaseController","sap/m/MessageBox","sap/m/MessageToast","sap/ui/model/json/JSONModel","sap/ui/core/Fragment","sap/ui/core/date/UI5Date","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/PDFViewer","sap/ui/core/Popup","sap/m/Popover"],function(e,t,a,r,o,n,i,s,l,d,g){"use strict";return e.extend("zmmsubcontract.controller.RegularASN",{_data:{dtValue:n.getInstance(),dtPattern:undefined},onInit:function(){e.prototype.onInit.apply(this);this._vMenge=null;this._localModel=this.getOwnerComponent().getModel("local");debugger;this.oRouter.getRoute("RegASN").attachPatternMatched(this._onObjectMatched,this);this.oRouter=this.getOwnerComponent().getRouter();this._userModel=this.getOwnerComponent().getModel("userModel");let t=localStorage.getItem("userInfo");if(t){let e=JSON.parse(t);this._userModel.setProperty("/",{email:e.email,user:e.user,scopes:e.scopes})}this.oRouter=this.getOwnerComponent().getRouter()},_readData:function(){this.getView().byId("idFilPlant1").setValue("");this.getView().byId("idFilDA1").setValue("");this.getView().byId("idFilVen1").setValue("");this.getView().byId("idMat1").setValue("");this.getView().byId("idPO1").setValue("");this._userModel=this.getOwnerComponent().getModel("userModel");let e=this._userModel.oData.email;debugger;let t=[new sap.ui.model.Filter("Email",sap.ui.model.FilterOperator.EQ,e)];var a=this.getOwnerComponent().getModel();var o=this.getOwnerComponent().getModel("selectedRecords");if(!o){o=new r([]);this.getOwnerComponent().setModel(o,"selectedRecords")}var n=this.getOwnerComponent().getModel("changedRecords");if(!n){n=new r([]);this.getOwnerComponent().setModel(n,"changedRecords")}this.getView().byId("idRegASN").setModel(a);var i=this;sap.ui.core.BusyIndicator.show(0);this.getOwnerComponent().setModel(a,"defaultModel");this.fetchDAList(e)},_onObjectMatched:function(e){this._refreshView()},_refreshView:function(){this._readData()},onSearchVendor:function(e){this._applySearchFilter("Lifnr",e.getParameter("query"))},onSearchWerks:function(e){this._applySearchFilter("Werks",e.getParameter("query"))},_applySearchFilter:function(e,t){var a=[];debugger;if(t&&t.length>0){var r=new i(e,s.Contains,t);a.push(r)}var o=this.byId("idDetail");var n=o.getBinding("items");n.filter(a,"Application")},_selectedData:function(e){var a=this.getOwnerComponent().getModel("selectedRecords");var r=this.getView();var o=r.byId("idRegASN");var n=o.getSelectedItems();var i=[];if(n.length===0){debugger;t.error("Please Enter at least one Record");return}var s=n[0].getBindingContext("default");var l=s.getProperty("Ebeln");var d=s.getProperty("Ebelp");debugger;n.forEach(function(e,a){a=a+1;if(a>4){t.error("You have selected more than 4 items. Please select up to 4 items only.");return}});var g=n.every(function(e){var t=e.getBindingContext("default");if(t){var a=t.getProperty("Ebeln");var r=t.getProperty("Ebelp");return a===l&&r===d}return false});if(!g){t.error("Please select records with the same PO and PO Line Item.");return}debugger;n.forEach(function(e){var t=e.getBindingContext("default");if(t){var a=t.getObject();i.push(t.getObject())}else{console.log("No binding context found for item:",e)}});sap.ui.getCore().setModel(a,"selectedItemsModel");a.setData(i);var c=sap.ui.core.UIComponent.getRouterFor(this);c.navTo("subconASNcr",{},false);debugger;var u={};u.vendor=a.oData[0].Lifnr;u.plant=a.oData[0].Werks;u.outputmat=a.oData[0].Op_matnr;u.Ebeln=a.oData[0].Ebeln;u.Ebelp=a.oData[0].Ebelp;var h=new sap.ui.model.json.JSONModel;h.setData(u);this.getOwnerComponent().setModel(h,"ASNMODEL");this._displayCrtAsnEH()},onCreateASN:function(e){this._selectedData(e)},_displayCrtAsnEH:function(){this.oRouter.navTo("subconASNcr")},onPreviewPDF:function(e){var t=e.getSource();var a=t.getBindingContext("default");var r=a.getObject();var o=this.getView();var n=o.getModel();var i=new l;this.getView().addDependent(i);var s="/zdapdfSet(Werks='"+r.Werks+"',Lifnr='"+r.Lifnr+"',Exnum='"+r.Exnum+"',Exdat='"+r.Exdat+"')/$value";n.read(s,{success:function(e){var t=n.sServiceUrl+s;i.setSource(t);i.setTitle("DA PDF");i.open()},error:function(e){var t="Preview not available for this Challan !!!";sap.m.MessageBox.error(t)}})},onMat:function(e){debugger;var t=e.getParameter("newValue");var a=this.byId("idRegASN");var r=a.getBinding("items");var o=[];if(t&&t.length>0){var n=new i("Op_matnr",s.Contains,t);var l=new i("Ip_Matnr",s.Contains,t);o.push(new i({filters:[n,l],and:false}))}r.filter(o)},onPlant:function(e){debugger;var t=e.getParameter("newValue");var a=this.byId("idRegASN");var r=a.getBinding("items");var o=[];if(t&&t.length>0){var n=new i("Werks",s.Contains,t);o.push(new i({filters:[n],and:false}))}r.filter(o)},onDA:function(e){debugger;var t=e.getParameter("newValue");var a=this.byId("idRegASN");var r=a.getBinding("items");var o=[];if(t&&t.length>0){var n=new i("Exnum",s.Contains,t);o.push(new i({filters:[n],and:false}))}r.filter(o)},onPO:function(e){debugger;var t=e.getParameter("newValue");var a=this.byId("idRegASN");var r=a.getBinding("items");var o=[];if(t&&t.length>0){var n=new i("Ebeln",s.Contains,t);o.push(new i({filters:[n],and:false}))}r.filter(o)},onVendor:function(e){debugger;var t=e.getParameter("newValue");var a=this.byId("idRegASN");var r=a.getBinding("items");var o=[];if(t&&t.length>0){var n=new i("Lifnr",s.Contains,t);o.push(new i({filters:[n],and:false}))}r.filter(o)},fetchDAList:async function(e){debugger;const t=this;sap.ui.core.BusyIndicator.show();try{const a=await $.ajax({url:"/nodeapp/dalist",method:"GET",contentType:"application/json",data:{email:e}});sap.ui.core.BusyIndicator.hide();const r=a;debugger;const o=new sap.ui.model.json.JSONModel(r);t.getView().setModel(o,"default");console.log("DA List fetched successfully:",r)}catch(e){sap.ui.core.BusyIndicator.hide();console.error("Error fetching DA List:",e);const t=e.responseJSON?.error?.innererror?.errordetails?.[0]?.message||"Unknown error occurred"}},onChangeMat:function(e){this._selectedPO(e)},_selectedPO:function(e){var a=this.getOwnerComponent().getModel("selectedRecords");var r=this.getView();var o=r.byId("idRegASN");var n=o.getSelectedItems();var i=[];if(n.length===0){debugger;t.error("Please Enter at least one Record");return}var s=n[0].getBindingContext("default");var l=s.getProperty("Ebeln");var d=s.getProperty("Ebelp");debugger;n.forEach(function(e,a){a=a+1;if(a>1){t.error("You have selected more than 1 items. Please select 1 record only.");return}});debugger;n.forEach(function(e){var t=e.getBindingContext("default");if(t){var a=t.getObject();i.push(t.getObject())}else{console.log("No binding context found for item:",e)}});sap.ui.getCore().setModel(a,"selectedItemsModel");a.setData(i);debugger;var g={};g.vendor=a.oData[0].Lifnr;g.plant=a.oData[0].Werks;g.outputmat=a.oData[0].Op_matnr;g.Ebeln=a.oData[0].Ebeln;g.Ebelp=a.oData[0].Ebelp;const c=a.oData[0].Ebeln;const u=a.oData[0].Ebelp;const h=a.oData[0].Ip_Matnr;const p=a.oData[0].Op_Matnr;this._vMenge=a.oData[0].Menge-a.oData[0].Menga;var f=new sap.ui.model.json.JSONModel;f.setData(g);this.getOwnerComponent().setModel(f,"ASNMODEL");debugger;const v=this.getView().getModel("default").getData();const M=v.filter(e=>e.Ebeln===c&&e.Ebelp!==u&&e.Ip_Matnr===h);if(M.length===0){sap.m.MessageBox.error("No records found for the selected PO");return}this._displaySelectMatRatio(M,c,u)},_displaySelectMatRatio:function(e,t,a){const r=new sap.ui.model.json.JSONModel(e);this.getView().setModel(r,"SelectMatModel");debugger;if(!this._oSelectMaterialDialog){o.load({id:this.getView().getId(),name:"zmmsubcontract.fragments.selMatPop",controller:this}).then(function(e){this._oSelectMaterialDialog=e;this.getView().addDependent(this._oSelectMaterialDialog);var t=sap.ui.core.Fragment.byId(this.getView().getId(),"idMaterialTable");if(t){t.setModel(this.getView().getModel("SelectMatModel"),"SelectMatModel")}this._oSelectMaterialDialog.open()}.bind(this)).catch(function(e){console.error("Error loading fragment:",e)})}else{var n=sap.ui.core.Fragment.byId(this.getView().getId(),"idMaterialTable");if(n){n.setModel(this.getView().getModel("SelectMatModel"),"SelectMatModel")}this._oSelectMaterialDialog.open()}},onCloseSelectMaterialDialog:function(){this._oSelectMaterialDialog.close()},onChangeSelectedMaterial:function(e){debugger;const a=this._vMenge;this.selectedchangedMaterial(e);debugger;var r=this.getOwnerComponent().getModel("selectedRecords");var o=this.getOwnerComponent().getModel("changedRecords");var n=this.getOwnerComponent().getModel("ASNMODEL");var i=r.getData();var s=o.getData();var l=n.getData();var d=s[0].Ratio;var g=a/d;g=parseFloat(g.toFixed(3));if(i&&i.length>0){i[0].Balqty=g;i[0].Op_matnr=s[0].Op_matnr;r.setData(i);this.getView().getModel("selectedRecords").refresh(true);l.Ebelp=s[0].Ebelp;n.setData(l);this.getView().getModel("ASNMODEL").refresh(true)}else{t.error("No data found in the selected records model.")}this._displayCrtAsnEH();this._oSelectMaterialDialog.close()},selectedchangedMaterial:function(e){var a=this.getOwnerComponent().getModel("changedRecords");var r=this.byId("idMaterialTable");var o=r.getSelectedItems();var n=[];debugger;if(o.length===0){debugger;t.error("Please Enter at least one Record");return}debugger;o.forEach(function(e){var t=e.getBindingContext("SelectMatModel");if(t){var a=t.getObject();n.push(t.getObject())}else{console.log("No binding context found for item:",e)}});sap.ui.getCore().setModel(a,"selectedItemsModel");a.setData(n)}})});
//# sourceMappingURL=RegularASN.controller.js.map