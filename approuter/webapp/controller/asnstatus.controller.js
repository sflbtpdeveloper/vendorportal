sap.ui.define(["zmmsubcontract/controller/BaseController","sap/m/MessageBox","sap/m/MessageToast","sap/ui/model/json/JSONModel","sap/ui/core/Fragment","sap/ui/core/date/UI5Date","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/PDFViewer"],function(e,t,r,a,n,o,i,s,u){"use strict";return e.extend("zmmsubcontract.controller.asnstatus",{_data:{dtValue:o.getInstance(),dtPattern:undefined},onBeforeRendering:function(){debugger;var e=this.getView().getModel();e.refresh(true)},onInit:function(){e.prototype.onInit.apply(this);this._localModel=this.getOwnerComponent().getModel("local");debugger;this.oRouter=this.getOwnerComponent().getRouter();this.oRouter.getRoute("asnstat").attachPatternMatched(this._onObjectMatched,this);this._userModel=this.getOwnerComponent().getModel("userModel");let t=localStorage.getItem("userInfo");if(t){let e=JSON.parse(t);this._userModel.setProperty("/",{email:e.email,user:e.user,scopes:e.scopes})}},onBeforeRendering:function(){if(this.oRouter){this.oRouter.getRoute("asnstat").detachPatternMatched(this._onObjectMatched,this)}},onAfterRendering:function(){if(this.oRouter){this.oRouter.getRoute("asnstat").attachPatternMatched(this._onObjectMatched,this)}},_readData:function(){this.getView().byId("idFilASN").setValue("");this.getView().byId("serInv").setValue("");this.getView().byId("idFilDCno").setValue("");this._userModel=this.getOwnerComponent().getModel("userModel");let e=this._userModel.oData.email;let t=[new sap.ui.model.Filter("Email",sap.ui.model.FilterOperator.EQ,e)];var r=this.getOwnerComponent().getModel("asncrt");r.refreshMetadata();r.refresh(true);this.getView().byId("idasnStat").setModel(r);var a=this;sap.ui.core.BusyIndicator.show(0);this.getOwnerComponent().setModel(r,"defaultModel");this.fetchASNStatus(e)},onRowSelect:function(){alert("Triggered")},onSearchVendor:function(e){this._applySearchFilter("Lifnr",e.getParameter("query"))},_onObjectMatched:function(e){debugger;this._readData()},_refreshView:function(){var e=this.byId("idRegASN");debugger;e.removeSelections(true)},onSearchVendor:function(e){this._applySearchFilter("Lifnr",e.getParameter("query"))},onSearchWerks:function(e){this._applySearchFilter("Werks",e.getParameter("query"))},_applySearchFilter:function(e,t){var r=[];if(t&&t.length>0){var a=new i(e,s.Contains,t);r.push(a)}var n=this.byId("idDetail");var o=n.getBinding("items");o.filter(r,"Application")},onFromAsnDateChange:function(e){this.applyFilters1()},onToAsnDateChange:function(e){this.applyFilters1()},applyFilters1:function(){var e=this.byId("idasnStat");if(!e){console.warn("Table not found!");return}var t=e.getBinding("items");if(!t){console.warn("Table binding not found!");return}var r=this.byId("fromAsnDate").getDateValue();var a=this.byId("toAsnDate").getDateValue();var n=[];if(r&&!a){var o=this.formatDateToYYYYMMDD(r);n.push(new sap.ui.model.Filter("Asndate1",sap.ui.model.FilterOperator.EQ,o))}else if(r&&a){var o=this.formatDateToYYYYMMDD(r);var i=this.formatDateToYYYYMMDD(a);n.push(new sap.ui.model.Filter("Asndate1",sap.ui.model.FilterOperator.BT,o,i))}if(n.length>0){t.filter(n,"Application")}else{t.filter([])}console.log("Applied Filters:",n)},formatDateToYYYYMMDD:function(e){if(!e)return null;var t=e.getFullYear();var r=String(e.getMonth()+1).padStart(2,"0");var a=String(e.getDate()).padStart(2,"0");return t+r+a},_selectedData:function(e){debugger;var t=e.getParameter("listItem");var r=t.getBindingContext("default");var a=r.getProperty("Lifnr");var n=r.getProperty("Werks");var o=r.getProperty("Op_matnr");var i=r.getProperty("Ip_Matnr");var s=r.getProperty("Maktx");var u=r.getProperty("Meins");var d=r.getProperty("Balqty");var l=r.getProperty("bprme");var c=r.getProperty("Exnum");var f={};f.vendor=a;f.plant=n;f.outputmat=o;f.inputmat=i;f.desc=s;f.uom=u;f.balqty=d;f.bprme=l;f.dano=c;var g=new sap.ui.model.json.JSONModel;g.setData(f);this.getOwnerComponent().setModel(g,"ASNMODEL")},captureRecordEH:function(e){this._selectedData(e);debugger;this.displayCrtAsnEH()},displayCrtAsnEH:function(){this.oRouter.navTo("subconASNcr")},onPreviewPDF:function(e){var t=e.getSource();var r=t.getBindingContext("default");var a=r.getObject();var n=this.getView();var o=n.getModel();var i=new u;this.getView().addDependent(i);var s=o.sServiceUrl;var d="/zdapdfSet(Werks='"+a.Werks+"',Lifnr='"+a.Lifnr+"',Exnum='"+a.Exnum+"',Exdat='"+a.Exdat+"')/$value";var l=s+"/zdapdfSet(Werks='"+a.Werks+"',Lifnr='"+a.Lifnr+"',Exnum='"+a.Exnum+"',Exdat='"+a.Exdat+"')/$value";i.setSource(l);i.setTitle("DA PDF");i.open()},onASN:function(e){debugger;var t=e.getParameter("newValue");var r=this.byId("idasnStat");var a=r.getBinding("items");var n=[];if(t&&t.length>0){var o=new i("Asnno",s.Contains,t);n.push(new i({filters:[o],and:false}))}a.filter(n)},onWerks:function(e){debugger;var t=e.getParameter("newValue");var r=this.byId("idasnStat");var a=r.getBinding("items");var n=[];if(t&&t.length>0){var o=new i("Werks",s.Contains,t);n.push(new i({filters:[o],and:false}))}a.filter(n)},onDCnumb:function(e){debugger;var t=e.getParameter("newValue");var r=this.byId("idasnStat");var a=r.getBinding("items");var n=[];if(t&&t.length>0){var o=new i("Dcno",s.Contains,t);n.push(new i({filters:[o],and:false}))}a.filter(n)},onInv:function(e){debugger;var t=e.getParameter("newValue");var r=this.byId("idasnStat");var a=r.getBinding("items");var n=[];if(t&&t.length>0){var o=new i("Ebeln",s.Contains,t);n.push(new i({filters:[o],and:false}))}a.filter(n)},onDCdate1:function(e){debugger;var t=e.getParameter("newValue");var r=this.byId("idasnStat");var a=r.getBinding("items");var n=[];if(t&&t.length>0){var o=new i("Dcdat1",s.Contains,t);n.push(new i({filters:[o],and:false}))}a.filter(n)},formatDate:function(e){if(e){var t=/\/Date\((\d+)\)\//.exec(e);if(t){var r=parseInt(t[1],10);var a=new Date(r);var n=sap.ui.core.format.DateFormat.getDateTimeInstance({pattern:"dd-MM-yyyy"});return n.format(a)}}return""},formatZeroValue:function(e){debugger;return e===null?"":e},jobstatff:function(e){if(e){return e==="C"?"/images/GTICK.jpg":"/images/RCROSS.jpg"}return e},isGrnoNonEmpty:function(e){return!!(e&&e.trim()!=="")},PayText:function(e){if(e==="P"){return"Completed"}else if(e==="NP"){return"Pending"}return" "},PayState:function(e){if(e==="P"){return"Success"}else if(e==="NP"){return"Error"}return"None"},PayIcon:function(e){if(e==="P"){return"sap-icon://accept"}else if(e==="NP"){return"sap-icon://decline"}return""},conditionalText:function(e){if(e==="0000000000"||e==="0000"||!e){return""}return e},fetchASNStatus:async function(e){debugger;const t=this;sap.ui.core.BusyIndicator.show();try{const r=await $.ajax({url:"/nodeapp/asnstatus",method:"GET",contentType:"application/json",data:{email:e}});sap.ui.core.BusyIndicator.hide();const a=r;debugger;const n=new sap.ui.model.json.JSONModel(a);t.getView().setModel(n,"asnrepModel")}catch(e){sap.ui.core.BusyIndicator.hide();console.error("Error fetching ASN Status Records:",e);const t=e.responseJSON?.error?.innererror?.errordetails?.[0]?.message||"Unknown error occurred"}},onDownloadExcel:function(){var e=this.byId("idasnStat");var t=this.byId("fromAsnDate").getDateValue();var r=this.byId("toAsnDate").getDateValue();var a=this.getView().getModel("asnrepModel");var n=a.getProperty("/");if(t&&!r){var o=this.formatDateToYYYYMMDD(t);n=n.filter(function(e){return e.Asndate1===o})}else if(t&&r){var o=this.formatDateToYYYYMMDD(t);var i=this.formatDateToYYYYMMDD(r);n=n.filter(function(e){return e.Asndate1>=o&&e.Asndate1<=i})}if(!n||n.length===0){sap.m.MessageBox.error("No records found to download.");return}var s=n.map(function(e){return{Plant:e.Werks,"ASN Number":e.Asnno,"Invoice No":e.Ebeln,"Invoice Item":e.Ebelp,"Material Code":e.Matnr,"Material Desc":e.Maktx,"DC No":e.Dcno,"DC Date":e.Dcdat1,"ASN Quantity":e.Asnqty,"Job Status":e.Grstatus,"ASN Status":e.Asnstatus,"DMRR Number":e.Dmrrno,"GR Number":e.Grno,"GR Number Item":e.Gritm,"IR Number":e.Irno,"Payment Status":e.Paystat,"Payment Reference":e.Payref,"Job Done Received":e.Accqty,"Job Not Done Received":e.Accqtyjnd,Rejected:e.Rejqty}});var u=this.convertToCsv(s);var d=new Blob([u],{type:"text/csv;charset=utf-8;"});var l=document.createElement("a");var c=URL.createObjectURL(d);l.setAttribute("href",c);l.setAttribute("download","subcontract_status_data.csv");l.style.visibility="hidden";document.body.appendChild(l);l.click();document.body.removeChild(l)},convertToCsv:function(e){var t="";var r=Object.keys(e[0]);t+=r.join(",")+"\r\n";e.forEach(function(e){t+=r.map(function(t){return e[t]?e[t].toString().replace(/,/g," "):""}).join(",")+"\r\n"});return t}})});
//# sourceMappingURL=asnstatus.controller.js.map