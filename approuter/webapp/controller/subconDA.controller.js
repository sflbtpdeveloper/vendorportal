sap.ui.define(["zmmsubcontract/controller/BaseController","sap/m/MessageBox","sap/m/MessageToast","sap/ui/model/json/JSONModel","sap/ui/core/Fragment","sap/ui/core/date/UI5Date","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/PDFViewer"],function(e,t,r,n,a,o,s,i,l){"use strict";return e.extend("zmmsubcontract.controller.subconDA",{_data:{dtValue:o.getInstance(),dtPattern:undefined},onInit:function(){e.prototype.onInit.apply(this);this._userModel=this.getOwnerComponent().getModel("userModel");let t=this;debugger;fetch("/getUserInformation").then(e=>e.json()).then(e=>{t._userModel.setProperty("/",{email:e.email,user:e.user,scopes:e.scopes});console.log(t._userModel.getProperty("/"));if(e.scopes&&e.scopes.length>1){let t=`Your scope: ${e.scopes[1]}`;sap.m.MessageToast.show(t,{duration:3e3})}else{sap.m.MessageToast.show("No specific scope found.",{duration:3e3})}}).catch(e=>console.log(e));this._localModel=this.getOwnerComponent().getModel("local");this.oRouter.getRoute("subconDA").attachPatternMatched(this._onObjectMatched,this);this.oRouter=this.getOwnerComponent().getRouter();this.oRouter=this.getOwnerComponent().getRouter()},_readData:function(){this.getView().byId("idFilPlant").setValue("");this.getView().byId("idFilDA").setValue("");this.getView().byId("idFilVen").setValue("");this.getView().byId("idSerMat").setValue("");this._userModel=this.getOwnerComponent().getModel("userModel");let e=localStorage.getItem("userInfo");if(e){let t=JSON.parse(e);this._userModel.setProperty("/",{email:t.email,user:t.user,scopes:t.scopes})}this._userModel=this.getOwnerComponent().getModel("userModel");let t=this._userModel.oData.email;let r=[new sap.ui.model.Filter("Email",sap.ui.model.FilterOperator.EQ,t)];var a=this.getOwnerComponent().getModel();var o=this.getOwnerComponent().getModel("selectedRecords");if(!o){o=new n([]);this.getOwnerComponent().setModel(o,"selectedRecords")}this.getView().byId("idDetail").setModel(a);var s=this;sap.ui.core.BusyIndicator.show(0);this.getOwnerComponent().setModel(a,"defaultModel");this.fetchDAList(t)},onRowSelect:function(){alert("Triggered")},onSearchVendor:function(e){this._applySearchFilter("Lifnr",e.getParameter("query"))},_onObjectMatched:function(e){this._refreshView()},_refreshView:function(){this._readData()},onSearchVendor:function(e){this._applySearchFilter("Lifnr",e.getParameter("query"))},onSearchWerks:function(e){this._applySearchFilter("Werks",e.getParameter("query"))},_applySearchFilter:function(e,t){var r=[];if(t&&t.length>0){var n=new s(e,i.Contains,t);r.push(n)}var a=this.byId("idDetail");var o=a.getBinding("items");o.filter(r,"Application")},_selectedData:function(e){debugger;var t=e.getParameter("listItem");var r=t.getBindingContext("default");var n=r.getProperty("Lifnr");var a=r.getProperty("Werks");var o=r.getProperty("Op_matnr");var s=r.getProperty("Ip_Matnr");var i=r.getProperty("Maktx");var l=r.getProperty("Meins");var d=r.getProperty("Balqty");var u=r.getProperty("bprme");var c=r.getProperty("Exnum");var g={};g.vendor=n;g.plant=a;g.outputmat=o;g.inputmat=s;g.desc=i;g.uom=l;g.balqty=d;g.bprme=u;g.dano=c;var p=new sap.ui.model.json.JSONModel;p.setData(g);this.getOwnerComponent().setModel(p,"ASNMODEL")},captureRecordEH:function(e){this._selectedData(e);debugger;this.displayCrtAsnEH()},displayCrtAsnEH:function(){this.oRouter.navTo("subconASNcr")},onPreviewPDF:function(e){var t=e.getSource();var r=t.getBindingContext("default");var n=r.getObject();if(n.Pdfchk==="X"){sap.m.MessageBox.error("Selected PO has No print Preview")}else{debugger;var a=this.getView();var o=a.getModel();var s=new l;this.getView().addDependent(s);var i=o.sServiceUrl;var d="/zdapdfSet(Werks='"+n.Werks+"',Lifnr='"+n.Lifnr+"',Exnum='"+n.Exnum+"',Exdat='"+n.Exdat+"')/$value";var u=i+"/zdapdfSet(Werks='"+n.Werks+"',Lifnr='"+n.Lifnr+"',Exnum='"+n.Exnum+"',Exdat='"+n.Exdat+"')/$value";s.setSource(u);s.setTitle("DA PDF");s.open()}},onMat:function(e){debugger;var t=e.getParameter("newValue");var r=this.byId("idDetail");var n=r.getBinding("items");var a=[];if(t&&t.length>0){var o=new s("Op_matnr",i.Contains,t);var l=new s("Ip_Matnr",i.Contains,t);a.push(new s({filters:[o,l],and:false}))}n.filter(a)},onPlant:function(e){debugger;var t=e.getParameter("newValue");var r=this.byId("idDetail");var n=r.getBinding("items");var a=[];if(t&&t.length>0){var o=new s("Werks",i.Contains,t);a.push(new s({filters:[o],and:false}))}n.filter(a)},onDA:function(e){debugger;var t=e.getParameter("newValue");var r=this.byId("idDetail");var n=r.getBinding("items");var a=[];if(t&&t.length>0){var o=new s("Exnum",i.Contains,t);a.push(new s({filters:[o],and:false}))}n.filter(a)},onVendor:function(e){debugger;var t=e.getParameter("newValue");var r=this.byId("idDetail");var n=r.getBinding("items");var a=[];if(t&&t.length>0){var o=new s("Lifnr",i.Contains,t);a.push(new s({filters:[o],and:false}))}n.filter(a)},onDownloadExcel:function(){var e=this.byId("idDetail");var t=this.getView().getModel("default");var r=t.getProperty("/");if(!r||r.length===0){sap.m.MessageBox.error("No records found to download.");return}var n=r.map(function(e){return{"DA Number":e.Exnum,"DA Date":e.Exdat,Plant:e.Werks,Vendor:e.Lifnr,"Output Part Number":e.Op_matnr,"Input Part Number":e.Ip_Matnr,"PO Number":e.Ebeln,"Balance Quantity":e.Balqty}});var a=this.convertToCsv(n);var o=new Blob([a],{type:"text/csv;charset=utf-8;"});var s=document.createElement("a");var i=URL.createObjectURL(o);s.setAttribute("href",i);s.setAttribute("download","subcontract_data.csv");s.style.visibility="hidden";document.body.appendChild(s);s.click();document.body.removeChild(s)},convertToCsv:function(e){var t="";var r=Object.keys(e[0]);t+=r.join(",")+"\r\n";e.forEach(function(e){t+=r.map(function(t){return e[t]?e[t].toString().replace(/,/g," "):""}).join(",")+"\r\n"});return t},fetchDAList:async function(e){debugger;const t=this;sap.ui.core.BusyIndicator.show();try{const r=await $.ajax({url:"/nodeapp/dalist",method:"GET",contentType:"application/json",data:{email:e}});sap.ui.core.BusyIndicator.hide();const n=r;console.log(n);const a=new sap.ui.model.json.JSONModel(n);t.getView().setModel(a,"default");console.log("DA List fetched successfully:",n)}catch(e){sap.ui.core.BusyIndicator.hide();console.error("Error fetching DA List:",e);const t=e.responseJSON?.error?.innererror?.errordetails?.[0]?.message||"Unknown error occurred"}}})});
//# sourceMappingURL=subconDA.controller.js.map