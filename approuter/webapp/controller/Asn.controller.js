sap.ui.define(["zmmsubcontract/controller/BaseController","sap/ui/core/mvc/Controller","sap/m/MessageToast","sap/m/MessageBox"],function(e,t,a,r){"use strict";return e.extend("zmmsubcontract.controller.Asn",{sSelectedKey:null,formatDateToYYYYMMDD:function(e){var t=new Date(e);var a=t.getFullYear();var r=String(t.getMonth()+1).padStart(2,"0");var s=String(t.getDate()).padStart(2,"0");return`${a}${r}${s}`},onInit:function(){e.prototype.onInit.apply(this);console.log("Asn Controller Initialized");this._loadSelectData();var t=this.getOwnerComponent().getRouter();t.getRoute("Asn").attachPatternMatched(this._onRouteMatched,this)},onBeforeRendering:function(){if(this.oRouter){this.oRouter.getRoute("Asn").detachPatternMatched(this._onRouteMatched,this)}},onAfterRendering:function(){this.oRouter.getRoute("Asn").attachPatternMatched(this._onRouteMatched,this)},_loadSelectData:function(){debugger;var e=this.getOwnerComponent().getModel("poservice");e.refreshMetadata();sap.ui.core.BusyIndicator.show(0);var t=this;this.fetchPackageType()},onSelectChange:function(e){debugger;var t=e.getSource();var a=t.getSelectedItem();this.sSelectedKey=a.getText()},onChange:function(e){var t=this.byId("SVENDOR");t.setVisible(e.getSource().getState())},_onRouteMatched:function(e){debugger;var t=localStorage.getItem("asnItemsData");var a;if(t){var r=JSON.parse(t);a=new sap.ui.model.json.JSONModel({results:r})}else{a=this.getOwnerComponent().getModel("asnItems")}this.getView().setModel(a,"asnItems");this.byId("_IDGenTable1").bindRows({path:"asnItems>/results"});this.sSelectedKey=null;this.getView().byId("ETA").setValue("");this.getView().byId("mySelect").setSelectedKey("");this.getView().byId("DCNO").setValue("");this.getView().byId("DCDATE").setValue("");this.getView().byId("PACKS").setValue("");this.getView().byId("LRNO").setValue("");this.getView().byId("LRDATE").setValue("");this.getView().byId("TNAME").setValue("");this.getView().byId("VEHNO").setValue("");this.getView().byId("SVENDOR").setValue("")},onToggleButtonPress:async function(e){debugger;var t=[];var a=e.getSource();var r=a.getPressed();var s={sDcno:this.byId("DCNO").getValue(),sDcdate:this.byId("DCDATE").getValue(),sPacks:String(this.byId("PACKS").getValue()),sLrno:this.byId("LRNO").getValue(),sLrdate:this.byId("LRDATE").getValue(),sTname:this.byId("TNAME").getValue(),sVehno:this.byId("VEHNO").getValue(),sBtype:this.sSelectedKey,sEta:this.byId("ETA").getValue()};if(!s.sLrdate){s.sLrdate=new Date(0)}var n=[];if(s.sVehno){var o=new sap.ui.model.Filter("VehNo",sap.ui.model.FilterOperator.EQ,s.sVehno);n.push(o)}var i=this.getOwnerComponent().getModel("poservice");var c=this;c._createASN(s)},validateLineItem:function(e,t){var a=parseFloat(e.Asnqty)||0;var s=parseFloat(e.Blqty)||0;var n=e.Asnweight||0;var o=e.Meins;var i=parseFloat(e.Max);var c=e.Maxind;if(c==="X"){if(a>i){r.error("Quantity exceeds maximum stock!");return}}if(c==="Y"){r.error("Maximum stock level not available for material");return}if(["PC","EA","NO"].includes(o)){if(a%1!==0){r.error("ASN Quantity cannot contain decimal values for the selected unit of measure.");return false}}if(!a||isNaN(a)||a<=0){r.error("Please Enter ASN Quantity for line item "+(t+1)+".");return false}if(!n||isNaN(n)||n<=0){r.error("Please Enter ASN Weight for line item "+(t+1)+".");return false}if(a>s){r.error("ASN Quantity must not be greater than BL Quantity for line item "+(t+1)+".");return false}return true},prepareItemData:function(e){return{Werks:e.Werks||"",Lifnr:e.Lifnr||"",Ebeln:e.Ebeln||"",Ebelp:e.Ebelp||"",Etenr:e.Etenr||"",Matnr:e.Matnr||"",Maktx:e.Maktx||"",Meins:e.Meins||"",Eindt:this.formatDateToYYYYMMDD(e.Eindt)||"",Menge:e.Menge||"",Wemng:e.Wemng||"",Blqty:e.Blqty||"",Netpr:e.Netpr||"",Peinh:e.Peinh||"",Asnqty:e.Asnqty||"",Asnweight:e.Asnweight||"",Remarks:e.Remarks||""}},createODataEntry:function(e,t){debugger;$.ajax({url:"/nodeapp/custom/supasnpost",type:"POST",contentType:"application/json; charset=UTF-8",data:JSON.stringify(t),headers:{"Content-Type":"application/json"},success:async function(e){debugger;var t=e.d.Ebeln;var a=this;if(t==="duplicate"){r.error("DC number already available in the Financial Year.",{duration:2e3});return}else r.success("ASN Number Created:"+t,{onClose:async function(){debugger;history.go(-1)}.bind(this)});this.clearInputs()}.bind(this),error:function(e){r.error("Error creating entry: "+e.message)}})},clearInputs:function(){this.byId("DCNO").setValue("");this.byId("DCDATE").setValue("");this.byId("PACKS").setValue("");this.byId("LRNO").setValue("");this.byId("LRDATE").setValue("");this.byId("TNAME").setValue("");this.byId("VEHNO").setValue("");this.byId("SVENDOR").setValue("");this.byId("ETA").setValue("");this.byId("mySelect").setSelectedKey("");this.byId("SVENDOR").setValue("")},fetchPackageType:async function(){debugger;const e=this;sap.ui.core.BusyIndicator.show();try{const t=await $.ajax({url:"/nodeapp/packtype",method:"GET",contentType:"application/json"});sap.ui.core.BusyIndicator.hide();const a=t;debugger;const r=new sap.ui.model.json.JSONModel(a);e.getView().setModel(r,"dropModel")}catch(e){sap.ui.core.BusyIndicator.hide();console.error("Error fetching Package Type:",e);const t=e.responseJSON?.error?.innererror?.errordetails?.[0]?.message||"Unknown error occurred";r.error(t)}},onDcDateChange:function(e){var t=e.getSource();var a=t.getValue();var s=new Date(a);var n=new Date;s.setHours(0,0,0,0);n.setHours(0,0,0,0);if(s>n){r.error("Invoice date cannot be a future date");return;this.byId("DCDATE").setValue("");return}},_createASN:function(e){var t=[];var a=new Date(e.sDcdate);var s=new Date;a.setHours(0,0,0,0);s.setHours(0,0,0,0);if(a>s){r.error("Invoice date cannot be a future date");return;this.byId("DCDATE").setValue("");return}var n=e.sPacks;var o=/^[+-]?\d+$/;if(!o.test(n)){r.error("Please enter a pack number without decimals.");return}if(this.byId("Switch").getState()&&!e.sLifnr2){t.push("Confirmatory Vendor is required.")}var i={sDcno:"Invoice Number",sDcdate:"Invoice Date",sPacks:"No Of Packs",sLrno:"LR No",sTname:"Transporter Name",sVehno:"Vehicle Number",sBtype:"Bag Type"};var c=["sLrno","sLrdate","sEta","sTname"];for(var l in e){if(e.hasOwnProperty(l)&&!c.includes(l)){if(!e[l]){var u=i[l]||l;t.push(u+" is required.")}}}if(t.length>0){r.error(t.join("\n"));return}var d=new sap.ui.model.odata.v2.ODataModel("/sap/opu/odata/sap/YMM_SUPPLIER_PO_SRV/");var h=this.byId("_IDGenTable1").getBinding("rows").getContexts();var g=[];for(var y=0;y<h.length;y++){var p=h[y].getObject();if(!this.validateLineItem(p,y))return;g.push(this.prepareItemData(p))}var f=e.sLrdate?this.formatDateToYYYYMMDD(e.sLrdate):"";var m=e.sEta?this.formatDateToYYYYMMDD(e.sEta):"";var v={Ebeln:"",Dcno:e.sDcno,Dcdate:this.formatDateToYYYYMMDD(e.sDcdate),Packs:e.sPacks,Lrno:e.sLrno,Lrdate:f,Tname:e.sTname,Vehno:e.sVehno,Btype:e.sBtype,Eta:m,Lifnr2:e.sLifnr2,HeaderToItem:g};this.createODataEntry(d,v)},onDCNOValidation:function(e){var t=e.getParameter("value");var a=e.getSource();if(t.length>16){a.setValueState("Error");a.setValueStateText("Only 16 characters allowed")}else{a.setValueState("None")}},onAttachFilePress:function(e){const t=document.createElement("input");t.type="file";t.accept="*/*";t.onchange=t=>{const a=t.target.files[0];if(a){const t=a.name;const r=a.type;const s=new FileReader;s.onload=a=>{const s=a.target.result;const n=this.convertToXstring(s);const o=e.getSource().getId();if(o.includes("invoiceAttachment")){this.getView().getModel("local").setProperty("/attachData/InvoiceFileName",t);this.getView().getModel("local").setProperty("/attachData/InvoiceFileBase64",n);this.getView().getModel("local").setProperty("/attachData/mimetype",r)}else if(o.includes("tsAttachment")){this.getView().getModel("local").setProperty("/attachData/TsFileName",t);this.getView().getModel("local").setProperty("/attachData/TsFileBase64",n);this.getView().getModel("local").setProperty("/attachData/mimetype",r)}};s.readAsArrayBuffer(a)}};t.click()},convertToXstring:function(e){const t=new Uint8Array(e);let a="";t.forEach(e=>{a+=e.toString(16).padStart(2,"0")});return a},uploadAttachments:async function(e){const t=this.getView().getModel("local");const s=t.getProperty("/attachData");debugger;const n=new sap.ui.model.odata.v2.ODataModel("/sap/opu/odata/sap/YMM_SUPPLIER_PO_SRV/");const o=(t,s,o,i)=>{if(!t||!s){return Promise.resolve()}let c=`${e}/`;c+=i+t;const l={AsnNumber:e,FileName:t,MimeType:o,Content:s};const u={slug:c};return new Promise((e,s)=>{n.create("/FileSet",l,{success:function(){a.show(`File uploaded successfully: ${t}`);e()},error:function(e){r.error(`Error uploading file: ${t}`);s(e)}})})};if(s.InvoiceFileName&&s.InvoiceFileBase64){await o(s.InvoiceFileName,s.InvoiceFileBase64,s.mimetype,"INV")}if(s.TsFileName&&s.TsFileBase64){await o(s.TsFileName,s.TsFileBase64,s.mimetype,"TSC")}}})});
//# sourceMappingURL=Asn.controller.js.map