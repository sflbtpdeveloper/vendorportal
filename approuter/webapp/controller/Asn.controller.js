sap.ui.define(["zmmsubcontract/controller/BaseController","sap/ui/core/mvc/Controller","sap/m/MessageToast","sap/m/MessageBox","sap/ui/unified/FileUploaderParameter","sap/ui/model/odata/v2/ODataModel"],function(e,t,a,s,r,i){"use strict";return e.extend("zmmsubcontract.controller.Asn",{sSelectedKey:null,formatDateToYYYYMMDD:function(e){var t=new Date(e);var a=t.getFullYear();var s=String(t.getMonth()+1).padStart(2,"0");var r=String(t.getDate()).padStart(2,"0");return`${a}${s}${r}`},onInit:function(){e.prototype.onInit.apply(this);console.log("Asn Controller Initialized");this._loadSelectData();var t=this.getOwnerComponent().getRouter();t.getRoute("Asn").attachPatternMatched(this._onRouteMatched,this)},onBeforeRendering:function(){if(this.oRouter){this.oRouter.getRoute("Asn").detachPatternMatched(this._onRouteMatched,this)}},onAfterRendering:function(){this.oRouter.getRoute("Asn").attachPatternMatched(this._onRouteMatched,this)},_loadSelectData:function(){debugger;var e=this.getOwnerComponent().getModel("poservice");e.refreshMetadata();sap.ui.core.BusyIndicator.show(0);var t=this;this.fetchPackageType()},onSelectChange:function(e){debugger;var t=e.getSource();var a=t.getSelectedItem();this.sSelectedKey=a.getText()},onChange:function(e){var t=this.byId("SVENDOR");t.setVisible(e.getSource().getState())},_onRouteMatched:function(e){debugger;var t=localStorage.getItem("asnItemsData");var a;if(t){var s=JSON.parse(t);a=new sap.ui.model.json.JSONModel({results:s})}else{a=this.getOwnerComponent().getModel("asnItems")}this.getView().setModel(a,"asnItems");this.byId("_IDGenTable1").bindRows({path:"asnItems>/results"});this.sSelectedKey=null;this.getView().byId("ETA").setValue("");this.getView().byId("mySelect").setSelectedKey("");this.getView().byId("DCNO").setValue("");this.getView().byId("DCDATE").setValue("");this.getView().byId("PACKS").setValue("");this.getView().byId("LRNO").setValue("");this.getView().byId("LRDATE").setValue("");this.getView().byId("TNAME").setValue("");this.getView().byId("VEHNO").setValue("");this.getView().byId("SVENDOR").setValue("");this.getView().byId("invoiceFileName").setText("");this.getView().byId("tsFileName").setText("");var r=this.getView().byId("invoiceAttachment");var i=this.getView().byId("tsAttachment");if(r){r.setValue("")}if(i){i.setValue("")}var n=this.byId("invoiceFileName");if(n){n.setText("")}var o=this.byId("tsFileName");if(o){o.setText("")}const l=new sap.ui.model.json.JSONModel({isSaveEnabled:true});this.getView().setModel(l,"saveButtonModel");this.getView().getModel("saveButtonModel").setProperty("/isSaveEnabled",true)},onToggleButtonPress:async function(e){debugger;var t=[];var a=e.getSource();var s=a.getPressed();var r={sDcno:this.byId("DCNO").getValue(),sDcdate:this.byId("DCDATE").getValue(),sPacks:String(this.byId("PACKS").getValue()),sLrno:this.byId("LRNO").getValue(),sLrdate:this.byId("LRDATE").getValue(),sTname:this.byId("TNAME").getValue(),sVehno:this.byId("VEHNO").getValue().replace(/\s+/g,""),sBtype:this.sSelectedKey,sEta:this.byId("ETA").getValue()};if(!r.sLrdate){r.sLrdate=new Date(0)}var i=[];if(r.sVehno){var n=new sap.ui.model.Filter("VehNo",sap.ui.model.FilterOperator.EQ,r.sVehno);i.push(n)}var o=this.getOwnerComponent().getModel("poservice");var l=this;l._createASN(r)},validateLineItem:function(e,t,a){var s=parseFloat(e.Asnqty)||0;var r=parseFloat(e.Blqty)||0;var i=e.Asnweight||0;var n=e.Meins;var o=e.Invvalue;var l=parseFloat(e.Max);var u=e.Maxind;var c=e.Aedat;var d=c.substring(0,4);var h=c.substring(4,6);var g=c.substring(6,8);var c=new Date(d,h-1,g);if(a<c){sap.m.MessageBox.error("DC date is Prior than PO creation date");return}if(u==="X"){if(s>l){sap.m.MessageBox.error("Quantity exceeds maximum stock!");return}}if(u==="Y"){sap.m.MessageBox.error("Maximum stock level not available for material");return}if(["PC","EA","NO"].includes(n)){if(s%1!==0){sap.m.MessageBox.error("ASN Quantity cannot contain decimal values for the selected unit of measure.");return false}}if(!o){sap.m.MessageBox.error("Please Enter Invoice Value for line item "+(t+1)+".");return false}if(!s||isNaN(s)||s<=0){sap.m.MessageBox.error("Please Enter ASN Quantity for line item "+(t+1)+".");return false}if(!i||isNaN(i)||i<=0){sap.m.MessageBox.error("Please Enter ASN Weight for line item "+(t+1)+".");return false}if(s>r){sap.m.MessageBox.error("ASN Quantity must not be greater than BL Quantity for line item "+(t+1)+".");return false}return true},prepareItemData:function(e){return{Werks:e.Werks||"",Lifnr:e.Lifnr||"",Ebeln:e.Ebeln||"",Ebelp:e.Ebelp||"",Etenr:e.Etenr||"",Matnr:e.Matnr||"",Maktx:e.Maktx||"",Meins:e.Meins||"",Eindt:this.formatDateToYYYYMMDD(e.Eindt)||"",Menge:e.Menge||"",Wemng:e.Wemng||"",Blqty:e.Blqty||"",Netpr:e.Netpr||"",Peinh:e.Peinh||"",Asnqty:e.Asnqty||"",Asnweight:e.Asnweight||"",Invvalue:e.Invvalue||"",Remarks:e.Remarks||""}},createODataEntry:function(e,t){debugger;$.ajax({url:"/nodeapp/custom/supasnpost",type:"POST",contentType:"application/json; charset=UTF-8",data:JSON.stringify(t),headers:{"Content-Type":"application/json"},success:async function(e){debugger;const t=e.d.Ebeln;if(t==="duplicate"){sap.m.MessageBox.error("DC number already available in the Financial Year.",{duration:2e3});return}await this.uploadAttachments(t);sap.m.MessageBox.show("ASN Number Created: "+t,{icon:sap.m.MessageBox.Icon.SUCCESS,title:"Success",actions:[sap.m.MessageBox.Action.OK],onClose:function(){debugger;const e=this.getView().getModel("local");e.setData({attachData:{mimetype:"",InvoiceFileName:"",InvoiceFileBase64:"",TsFileName:"",TsFileBase64:""}});history.go(-1)}.bind(this)});this.clearInputs()}.bind(this),error:function(e){sap.m.MessageBox.error("Error creating entry: "+e.message)}})},clearInputs:function(){this.byId("DCNO").setValue("");this.byId("DCDATE").setValue("");this.byId("PACKS").setValue("");this.byId("LRNO").setValue("");this.byId("LRDATE").setValue("");this.byId("TNAME").setValue("");this.byId("VEHNO").setValue("");this.byId("SVENDOR").setValue("");this.byId("ETA").setValue("");this.byId("mySelect").setSelectedKey("");this.byId("SVENDOR").setValue("")},fetchPackageType:async function(){debugger;const e=this;sap.ui.core.BusyIndicator.show();try{const t=await $.ajax({url:"/nodeapp/packtype",method:"GET",contentType:"application/json"});sap.ui.core.BusyIndicator.hide();const a=t;debugger;const s=new sap.ui.model.json.JSONModel(a);e.getView().setModel(s,"dropModel")}catch(e){sap.ui.core.BusyIndicator.hide();console.error("Error fetching Package Type:",e);const t=e.responseJSON?.error?.innererror?.errordetails?.[0]?.message||"Unknown error occurred";sap.m.MessageBox.error(t)}},onDcDateChange:function(e){var t=e.getSource();var a=t.getValue();var s=new Date(a);var r=new Date;s.setHours(0,0,0,0);r.setHours(0,0,0,0);if(s>r){sap.m.MessageBox.error("Invoice date cannot be a future date");return;this.byId("DCDATE").setValue("");return}},_createASN:function(e){var t=[];var a=new Date(e.sDcdate);var s=new Date;a.setHours(0,0,0,0);s.setHours(0,0,0,0);if(a>s){sap.m.MessageBox.error("Invoice date cannot be a future date");return;this.byId("DCDATE").setValue("");return}var r=e.sPacks;var i=/^[+-]?\d+$/;if(!i.test(r)){sap.m.MessageBox.error("Please enter a pack number without decimals.");return}if(this.byId("Switch").getState()&&!e.sLifnr2){t.push("Confirmatory Vendor is required.")}var n={sDcno:"Invoice Number",sDcdate:"Invoice Date",sPacks:"No Of Packs",sLrno:"LR No",sTname:"Transporter Name",sVehno:"Vehicle Number",sBtype:"Bag Type"};var o=["sLrno","sLrdate","sEta","sTname"];for(var l in e){if(e.hasOwnProperty(l)&&!o.includes(l)){if(!e[l]){var u=n[l]||l;t.push(u+" is required.")}}}if(t.length>0){sap.m.MessageBox.error(t.join("\n"));return}var c=new sap.ui.model.odata.v2.ODataModel("/sap/opu/odata/sap/YMM_SUPPLIER_PO_SRV/");var d=this.byId("_IDGenTable1").getBinding("rows").getContexts();var h=[];for(var g=0;g<d.length;g++){var m=d[g].getObject();if(!this.validateLineItem(m,g,a))return;h.push(this.prepareItemData(m))}var p=e.sLrdate?this.formatDateToYYYYMMDD(e.sLrdate):"";var y=e.sEta?this.formatDateToYYYYMMDD(e.sEta):"";var v={Ebeln:"",Dcno:e.sDcno,Dcdate:this.formatDateToYYYYMMDD(e.sDcdate),Packs:e.sPacks,Lrno:e.sLrno,Lrdate:p,Tname:e.sTname,Vehno:e.sVehno,Btype:e.sBtype,Eta:y,Lifnr2:e.sLifnr2,HeaderToItem:h};this.createODataEntry(c,v)},onDCNOValidation:function(e){var t=e.getParameter("value");var a=e.getSource();if(t.length>16){a.setValueState("Error");a.setValueStateText("Only 16 characters allowed")}else{a.setValueState("None")}},uploadAttachments:async function(e){const t=this.getView().getModel("local");const a=t.getProperty("/attachData");debugger;const s=new sap.ui.model.odata.v2.ODataModel("/sap/opu/odata/sap/YMM_SUPPLIER_ATT_SRV/");const r=()=>new Promise((e,t)=>{s.refreshSecurityToken(()=>{const a=s.getSecurityToken();if(a){e(a)}else{t(new Error("Failed to retrieve CSRF token."))}},e=>{t(new Error("Failed to refresh CSRF token: "+JSON.stringify(e)))})});const i=(t,a,s)=>{if(!t){return Promise.resolve()}let i=`${e}/`;i+=s+t;var n;if(s==="INV"){n=this.getView().byId("invoiceAttachment")}else if(s==="TSC"){n=this.getView().byId("tsAttachment")}if(n){n.destroyHeaderParameters();n.addHeaderParameter(new sap.ui.unified.FileUploaderParameter({name:"SLUG",value:i}));return new Promise(async(e,t)=>{try{const a=await r();n.addHeaderParameter(new sap.ui.unified.FileUploaderParameter({name:"x-csrf-token",value:a}));n.setSendXHR(true);n.upload();n.attachUploadComplete(a=>{const s=a.getParameter("status");if(s===200||s===201){e()}else{t(new Error("File upload failed with status: "+s))}})}catch(e){t(e)}})}};const n=this.getView().byId("invoiceAttachment");const o=this.getView().byId("tsAttachment");if(a.InvoiceFileName){await i(a.InvoiceFileName,a.mimetype,"INV")}if(a.TsFileName){await i(a.TsFileName,a.mimetype,"TSC")}if(n){n.setValue("")}if(o){o.setValue("")}t.setProperty("/attachData/InvoiceFileName","");t.setProperty("/attachData/TsFileName","");this.byId("invoiceFileName").setText("");this.byId("tsFileName").setText("")},onFileChangedI:function(e){var t=e.getSource();var a=t.getValue();this.getView().getModel("local").setProperty("/attachData/InvoiceFileName",a);var s=this.byId("invoiceFileName");s.setText(a)},onFileChangedT:function(e){var t=e.getSource();var a=t.getValue();this.getView().getModel("local").setProperty("/attachData/TsFileName",a);var s=this.byId("tsFileName");s.setText(a)}})});
//# sourceMappingURL=Asn.controller.js.map